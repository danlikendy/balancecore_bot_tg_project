#!/bin/bash

# BalanceCore Bot Development Script
# ะกะบัะธะฟั ะดะปั ะทะฐะฟััะบะฐ ะฒ ัะตะถะธะผะต ัะฐะทัะฐะฑะพัะบะธ

set -e

echo "๐ง ะะฐะฟััะบ BalanceCore Bot ะฒ ัะตะถะธะผะต ัะฐะทัะฐะฑะพัะบะธ..."

# ะะบัะธะฒะธััะตะผ ะฒะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต
if [ -d "venv" ]; then
    echo "๐ฆ ะะบัะธะฒะฐัะธั ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั..."
    source venv/bin/activate
fi

# ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต .env ัะฐะนะปะฐ
if [ ! -f ".env" ]; then
    echo "โ ะคะฐะนะป .env ะฝะต ะฝะฐะนะดะตะฝ. ะะฐะฟัััะธัะต ัะฝะฐัะฐะปะฐ: make setup"
    exit 1
fi

# ะะฐะณััะถะฐะตะผ ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั
export $(cat .env | grep -v '^#' | xargs)

# ะัะพะฒะตััะตะผ ะฟะพะดะบะปััะตะฝะธะต ะบ ะฑะฐะทะต ะดะฐะฝะฝัั
echo "๐ ะัะพะฒะตัะบะฐ ะฟะพะดะบะปััะตะฝะธั ะบ ะฑะฐะทะต ะดะฐะฝะฝัั..."
if ! python -c "
import psycopg2
try:
    conn = psycopg2.connect('$DATABASE_URL')
    conn.close()
    print('โ ะะฐะทะฐ ะดะฐะฝะฝัั ะดะพัััะฟะฝะฐ')
except Exception as e:
    print(f'โ ะัะธะฑะบะฐ ะฟะพะดะบะปััะตะฝะธั ะบ ะฑะฐะทะต ะดะฐะฝะฝัั: {e}')
    exit(1)
"; then
    echo "โ ะะต ัะดะฐะตััั ะฟะพะดะบะปััะธัััั ะบ ะฑะฐะทะต ะดะฐะฝะฝัั"
    echo "ะฃะฑะตะดะธัะตัั, ััะพ PostgreSQL ะทะฐะฟััะตะฝ ะธ ะฝะฐัััะพะนะบะธ ะฒ .env ะบะพััะตะบัะฝั"
    exit 1
fi

# ะะฐะฟััะบะฐะตะผ ะผะธะณัะฐัะธะธ
echo "๐ ะะฐะฟััะบ ะผะธะณัะฐัะธะน ะฑะฐะทั ะดะฐะฝะฝัั..."
alembic upgrade head

# ะะฐะฟััะบะฐะตะผ API ัะตัะฒะตั ะฒ ัะพะฝะต
echo "๐ ะะฐะฟััะบ API ัะตัะฒะตัะฐ..."
uvicorn api.main:app --host 0.0.0.0 --port 8000 --reload &
API_PID=$!

# ะะดะตะผ ะทะฐะฟััะบะฐ API
sleep 3

# ะัะพะฒะตััะตะผ, ััะพ API ะทะฐะฟัััะธะปัั
if ! curl -s http://localhost:8000/health > /dev/null; then
    echo "โ API ัะตัะฒะตั ะฝะต ะทะฐะฟัััะธะปัั"
    kill $API_PID 2>/dev/null || true
    exit 1
fi

echo "โ API ัะตัะฒะตั ะทะฐะฟััะตะฝ ะฝะฐ http://localhost:8000"

# ะะฐะฟััะบะฐะตะผ ะฑะพัะฐ
echo "๐ค ะะฐะฟััะบ Telegram ะฑะพัะฐ..."
python bot/main.py &
BOT_PID=$!

# ะคัะฝะบัะธั ะดะปั ะบะพััะตะบัะฝะพะณะพ ะทะฐะฒะตััะตะฝะธั
cleanup() {
    echo ""
    echo "๐ ะะฐะฒะตััะตะฝะธะต ัะฐะฑะพัั..."
    kill $API_PID 2>/dev/null || true
    kill $BOT_PID 2>/dev/null || true
    echo "โ ะัะต ะฟัะพัะตััั ะพััะฐะฝะพะฒะปะตะฝั"
    exit 0
}

# ะะฑัะฐะฑะพัะบะฐ ัะธะณะฝะฐะปะพะฒ
trap cleanup SIGINT SIGTERM

echo ""
echo "โ BalanceCore Bot ะทะฐะฟััะตะฝ!"
echo ""
echo "๐ API: http://localhost:8000"
echo "๐จโ๐ผ ะะดะผะธะฝ-ะฟะฐะฝะตะปั: http://localhost:8000/admin"
echo "๐ API ะดะพะบัะผะตะฝัะฐัะธั: http://localhost:8000/docs"
echo ""
echo "ะะฐะถะผะธัะต Ctrl+C ะดะปั ะพััะฐะฝะพะฒะบะธ"

# ะะดะตะผ ะทะฐะฒะตััะตะฝะธั
wait
